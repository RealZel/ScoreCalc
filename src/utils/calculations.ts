import {
  lengthForAgeBoysNew,
  lengthForAgeGirlsNew,
  weightForAgeBoysNew,
  weightForAgeGirlsNew,
  headCircForAgeBoysNew,
  headCircForAgeGirlsNew,
} from './whoLms0to60';
import {
  bmiForAgeBoysDaily0to5,
  bmiForAgeGirlsDaily0to5,
} from './whoBmiDaily0to5';

// WHO Child Growth Standards - Official LMS Data from CDC/WHO
// Data source: https://www.cdc.gov/growthcharts/who-data-files.htm
// Age is in MONTHS (0-60 months for core WHO indicators in this app)
//
// LMS Formula (from CDC):
// Z-score = ((X/M)^L - 1) / (L × S), when L ≠ 0
// Z-score = ln(X/M) / S, when L = 0
//
// Where:
// X = measured value (weight in kg, length in cm, head circ in cm)
// L = Box-Cox transformation power (Lambda)
// M = Median
// S = Generalized coefficient of variation (Sigma)

// ============================================================
// WEIGHT-FOR-AGE: Boys (0-24 months)
// ============================================================
export const weightForAgeBoys: Record<number, { L: number; M: number; S: number }> = {
  0: { L: 0.3487, M: 3.3464, S: 0.14602 },
  1: { L: 0.2297, M: 4.4709, S: 0.13395 },
  2: { L: 0.197, M: 5.5675, S: 0.12385 },
  3: { L: 0.1738, M: 6.3762, S: 0.11727 },
  4: { L: 0.1553, M: 7.0023, S: 0.11316 },
  5: { L: 0.1395, M: 7.5105, S: 0.1108 },
  6: { L: 0.1257, M: 7.934, S: 0.10958 },
  7: { L: 0.1134, M: 8.297, S: 0.10902 },
  8: { L: 0.1021, M: 8.6151, S: 0.10882 },
  9: { L: 0.0917, M: 8.9014, S: 0.10881 },
  10: { L: 0.082, M: 9.1649, S: 0.10891 },
  11: { L: 0.073, M: 9.4122, S: 0.10906 },
  12: { L: 0.0644, M: 9.6479, S: 0.10925 },
  13: { L: 0.0563, M: 9.8749, S: 0.10949 },
  14: { L: 0.0487, M: 10.0953, S: 0.10976 },
  15: { L: 0.0413, M: 10.3108, S: 0.11007 },
  16: { L: 0.0343, M: 10.5228, S: 0.11041 },
  17: { L: 0.0275, M: 10.7319, S: 0.11079 },
  18: { L: 0.0211, M: 10.9385, S: 0.11119 },
  19: { L: 0.0148, M: 11.143, S: 0.11164 },
  20: { L: 0.0087, M: 11.3462, S: 0.11211 },
  21: { L: 0.0029, M: 11.5486, S: 0.11261 },
  22: { L: -0.0028, M: 11.7504, S: 0.11314 },
  23: { L: -0.0083, M: 11.9514, S: 0.11369 },
  24: { L: -0.0137, M: 12.1515, S: 0.11426 },
};

// ============================================================
// WEIGHT-FOR-AGE: Girls (0-24 months)
// ============================================================
export const weightForAgeGirls: Record<number, { L: number; M: number; S: number }> = {
  0: { L: 0.3809, M: 3.2322, S: 0.14171 },
  1: { L: 0.1714, M: 4.1873, S: 0.13724 },
  2: { L: 0.0962, M: 5.1282, S: 0.13 },
  3: { L: 0.0402, M: 5.8458, S: 0.12619 },
  4: { L: -0.005, M: 6.4237, S: 0.12402 },
  5: { L: -0.043, M: 6.8985, S: 0.12274 },
  6: { L: -0.0756, M: 7.297, S: 0.12204 },
  7: { L: -0.1039, M: 7.6422, S: 0.12178 },
  8: { L: -0.1288, M: 7.9487, S: 0.12181 },
  9: { L: -0.1507, M: 8.2254, S: 0.12199 },
  10: { L: -0.17, M: 8.48, S: 0.12223 },
  11: { L: -0.1872, M: 8.7192, S: 0.12247 },
  12: { L: -0.2024, M: 8.9481, S: 0.12268 },
  13: { L: -0.2158, M: 9.1699, S: 0.12283 },
  14: { L: -0.2278, M: 9.387, S: 0.12294 },
  15: { L: -0.2384, M: 9.6008, S: 0.12299 },
  16: { L: -0.2478, M: 9.8124, S: 0.12303 },
  17: { L: -0.2562, M: 10.0226, S: 0.12306 },
  18: { L: -0.2637, M: 10.2315, S: 0.12309 },
  19: { L: -0.2703, M: 10.4393, S: 0.12315 },
  20: { L: -0.2762, M: 10.6464, S: 0.12323 },
  21: { L: -0.2815, M: 10.8534, S: 0.12335 },
  22: { L: -0.2862, M: 11.0608, S: 0.1235 },
  23: { L: -0.2903, M: 11.2688, S: 0.12369 },
  24: { L: -0.2941, M: 11.4775, S: 0.1239 },
};

// ============================================================
// LENGTH-FOR-AGE: Boys (0-24 months)
// ============================================================
export const lengthForAgeBoys: Record<number, { L: number; M: number; S: number }> = {
  0: { L: 1, M: 49.8842, S: 0.03795 },
  1: { L: 1, M: 54.7244, S: 0.03557 },
  2: { L: 1, M: 58.4249, S: 0.03424 },
  3: { L: 1, M: 61.4292, S: 0.03328 },
  4: { L: 1, M: 63.886, S: 0.03257 },
  5: { L: 1, M: 65.9026, S: 0.03204 },
  6: { L: 1, M: 67.6236, S: 0.03165 },
  7: { L: 1, M: 69.1645, S: 0.03139 },
  8: { L: 1, M: 70.5994, S: 0.03124 },
  9: { L: 1, M: 71.9687, S: 0.03117 },
  10: { L: 1, M: 73.2812, S: 0.03118 },
  11: { L: 1, M: 74.5388, S: 0.03125 },
  12: { L: 1, M: 75.7488, S: 0.03137 },
  13: { L: 1, M: 76.9186, S: 0.03154 },
  14: { L: 1, M: 78.0497, S: 0.03174 },
  15: { L: 1, M: 79.1458, S: 0.03197 },
  16: { L: 1, M: 80.2113, S: 0.03222 },
  17: { L: 1, M: 81.2487, S: 0.0325 },
  18: { L: 1, M: 82.2587, S: 0.03279 },
  19: { L: 1, M: 83.2418, S: 0.0331 },
  20: { L: 1, M: 84.1996, S: 0.03342 },
  21: { L: 1, M: 85.1348, S: 0.03376 },
  22: { L: 1, M: 86.0477, S: 0.0341 },
  23: { L: 1, M: 86.941, S: 0.03445 },
  24: { L: 1, M: 87.8161, S: 0.03479 },
};

// ============================================================
// LENGTH-FOR-AGE: Girls (0-24 months)
// ============================================================
export const lengthForAgeGirls: Record<number, { L: number; M: number; S: number }> = {
  0: { L: 1, M: 49.1477, S: 0.0379 },
  1: { L: 1, M: 53.6872, S: 0.0364 },
  2: { L: 1, M: 57.0673, S: 0.03568 },
  3: { L: 1, M: 59.8029, S: 0.0352 },
  4: { L: 1, M: 62.0899, S: 0.03486 },
  5: { L: 1, M: 64.0301, S: 0.03463 },
  6: { L: 1, M: 65.7311, S: 0.03448 },
  7: { L: 1, M: 67.2873, S: 0.03441 },
  8: { L: 1, M: 68.7498, S: 0.0344 },
  9: { L: 1, M: 70.1435, S: 0.03444 },
  10: { L: 1, M: 71.4818, S: 0.03452 },
  11: { L: 1, M: 72.771, S: 0.03464 },
  12: { L: 1, M: 74.015, S: 0.03479 },
  13: { L: 1, M: 75.2176, S: 0.03496 },
  14: { L: 1, M: 76.3817, S: 0.03514 },
  15: { L: 1, M: 77.5099, S: 0.03534 },
  16: { L: 1, M: 78.6055, S: 0.03555 },
  17: { L: 1, M: 79.671, S: 0.03576 },
  18: { L: 1, M: 80.7079, S: 0.03598 },
  19: { L: 1, M: 81.7182, S: 0.0362 },
  20: { L: 1, M: 82.7036, S: 0.03643 },
  21: { L: 1, M: 83.6654, S: 0.03666 },
  22: { L: 1, M: 84.6040, S: 0.03688 },
  23: { L: 1, M: 85.5202, S: 0.03711 },
  24: { L: 1, M: 86.4153, S: 0.03734 },
};

// ============================================================
// HEAD CIRCUMFERENCE-FOR-AGE: Boys (0-24 months)
// ============================================================
export const headCircForAgeBoys: Record<number, { L: number; M: number; S: number }> = {
  0: { L: 1, M: 34.4618, S: 0.03686 },
  1: { L: 1, M: 37.2759, S: 0.03133 },
  2: { L: 1, M: 39.1285, S: 0.02997 },
  3: { L: 1, M: 40.5135, S: 0.02918 },
  4: { L: 1, M: 41.6317, S: 0.02868 },
  5: { L: 1, M: 42.5576, S: 0.02837 },
  6: { L: 1, M: 43.3306, S: 0.02817 },
  7: { L: 1, M: 43.9803, S: 0.02804 },
  8: { L: 1, M: 44.53, S: 0.02796 },
  9: { L: 1, M: 44.9998, S: 0.02792 },
  10: { L: 1, M: 45.4051, S: 0.0279 },
  11: { L: 1, M: 45.7573, S: 0.02789 },
  12: { L: 1, M: 46.0661, S: 0.02789 },
  13: { L: 1, M: 46.3395, S: 0.02789 },
  14: { L: 1, M: 46.5844, S: 0.02791 },
  15: { L: 1, M: 46.806, S: 0.02792 },
  16: { L: 1, M: 47.0088, S: 0.02795 },
  17: { L: 1, M: 47.1962, S: 0.02797 },
  18: { L: 1, M: 47.3711, S: 0.028 },
  19: { L: 1, M: 47.5357, S: 0.02803 },
  20: { L: 1, M: 47.6919, S: 0.02806 },
  21: { L: 1, M: 47.8408, S: 0.0281 },
  22: { L: 1, M: 47.9833, S: 0.02813 },
  23: { L: 1, M: 48.1201, S: 0.02817 },
  24: { L: 1, M: 48.2515, S: 0.02821 },
};

// ============================================================
// HEAD CIRCUMFERENCE-FOR-AGE: Girls (0-24 months)
// ============================================================
export const headCircForAgeGirls: Record<number, { L: number; M: number; S: number }> = {
  0: { L: 1, M: 33.8787, S: 0.03496 },
  1: { L: 1, M: 36.5463, S: 0.0321 },
  2: { L: 1, M: 38.2521, S: 0.03168 },
  3: { L: 1, M: 39.5328, S: 0.0314 },
  4: { L: 1, M: 40.5817, S: 0.03119 },
  5: { L: 1, M: 41.459, S: 0.03102 },
  6: { L: 1, M: 42.1995, S: 0.03087 },
  7: { L: 1, M: 42.829, S: 0.03075 },
  8: { L: 1, M: 43.3671, S: 0.03063 },
  9: { L: 1, M: 43.83, S: 0.03053 },
  10: { L: 1, M: 44.2319, S: 0.03044 },
  11: { L: 1, M: 44.5844, S: 0.03035 },
  12: { L: 1, M: 44.8965, S: 0.03027 },
  13: { L: 1, M: 45.1752, S: 0.03019 },
  14: { L: 1, M: 45.4265, S: 0.03012 },
  15: { L: 1, M: 45.6551, S: 0.03006 },
  16: { L: 1, M: 45.865, S: 0.03 },
  17: { L: 1, M: 46.0598, S: 0.02994 },
  18: { L: 1, M: 46.2424, S: 0.02989 },
  19: { L: 1, M: 46.4152, S: 0.02984 },
  20: { L: 1, M: 46.5801, S: 0.02981 },
  21: { L: 1, M: 46.7384, S: 0.02978 },
  22: { L: 1, M: 46.8913, S: 0.02975 },
  23: { L: 1, M: 47.0391, S: 0.02973 },
  24: { L: 1, M: 47.1822, S: 0.02971 },
};

// ============================================================
// WHO BMI-FOR-AGE: Boys (61-228 months / 5-19 years)
// Source: WHO Growth Reference Data for 5-19 years
// https://www.who.int/tools/growth-reference-data-for-5to19-years/indicators/bmi-for-age
// ============================================================
export const bmiForAgeBoys: Record<number, { L: number; M: number; S: number }> = {
  61: { L: -0.7387, M: 15.2641, S: 0.0839 },
  62: { L: -0.7621, M: 15.2616, S: 0.08414 },
  63: { L: -0.7856, M: 15.2604, S: 0.08439 },
  64: { L: -0.8089, M: 15.2605, S: 0.08464 },
  65: { L: -0.8322, M: 15.2619, S: 0.0849 },
  66: { L: -0.8554, M: 15.2645, S: 0.08516 },
  67: { L: -0.8785, M: 15.2684, S: 0.08543 },
  68: { L: -0.9015, M: 15.2737, S: 0.0857 },
  69: { L: -0.9243, M: 15.2801, S: 0.08597 },
  70: { L: -0.9471, M: 15.2877, S: 0.08625 },
  71: { L: -0.9697, M: 15.2965, S: 0.08653 },
  72: { L: -0.9921, M: 15.3062, S: 0.08682 },
  73: { L: -1.0144, M: 15.3169, S: 0.08711 },
  74: { L: -1.0365, M: 15.3285, S: 0.08741 },
  75: { L: -1.0584, M: 15.3408, S: 0.08771 },
  76: { L: -1.0801, M: 15.354, S: 0.08802 },
  77: { L: -1.1017, M: 15.3679, S: 0.08833 },
  78: { L: -1.123, M: 15.3825, S: 0.08865 },
  79: { L: -1.1441, M: 15.3978, S: 0.08898 },
  80: { L: -1.1649, M: 15.4137, S: 0.08931 },
  81: { L: -1.1856, M: 15.4302, S: 0.08964 },
  82: { L: -1.206, M: 15.4473, S: 0.08998 },
  83: { L: -1.2261, M: 15.465, S: 0.09033 },
  84: { L: -1.246, M: 15.4832, S: 0.09068 },
  85: { L: -1.2656, M: 15.5019, S: 0.09103 },
  86: { L: -1.2849, M: 15.521, S: 0.09139 },
  87: { L: -1.304, M: 15.5407, S: 0.09176 },
  88: { L: -1.3228, M: 15.5608, S: 0.09213 },
  89: { L: -1.3414, M: 15.5814, S: 0.09251 },
  90: { L: -1.3596, M: 15.6023, S: 0.09289 },
  91: { L: -1.3776, M: 15.6237, S: 0.09327 },
  92: { L: -1.3953, M: 15.6455, S: 0.09366 },
  93: { L: -1.4126, M: 15.6677, S: 0.09406 },
  94: { L: -1.4297, M: 15.6903, S: 0.09445 },
  95: { L: -1.4464, M: 15.7133, S: 0.09486 },
  96: { L: -1.4629, M: 15.7368, S: 0.09526 },
  97: { L: -1.479, M: 15.7606, S: 0.09567 },
  98: { L: -1.4947, M: 15.7848, S: 0.09609 },
  99: { L: -1.5101, M: 15.8094, S: 0.09651 },
  100: { L: -1.5252, M: 15.8344, S: 0.09693 },
  101: { L: -1.5399, M: 15.8597, S: 0.09735 },
  102: { L: -1.5542, M: 15.8855, S: 0.09778 },
  103: { L: -1.5681, M: 15.9116, S: 0.09821 },
  104: { L: -1.5817, M: 15.9381, S: 0.09864 },
  105: { L: -1.5948, M: 15.9651, S: 0.09907 },
  106: { L: -1.6076, M: 15.9925, S: 0.09951 },
  107: { L: -1.6199, M: 16.0205, S: 0.09994 },
  108: { L: -1.6318, M: 16.049, S: 0.10038 },
  109: { L: -1.6433, M: 16.0781, S: 0.10082 },
  110: { L: -1.6544, M: 16.1078, S: 0.10126 },
  111: { L: -1.6651, M: 16.1381, S: 0.1017 },
  112: { L: -1.6753, M: 16.1692, S: 0.10214 },
  113: { L: -1.6851, M: 16.2009, S: 0.10259 },
  114: { L: -1.6944, M: 16.2333, S: 0.10303 },
  115: { L: -1.7032, M: 16.2665, S: 0.10347 },
  116: { L: -1.7116, M: 16.3004, S: 0.10391 },
  117: { L: -1.7196, M: 16.3351, S: 0.10435 },
  118: { L: -1.7271, M: 16.3704, S: 0.10478 },
  119: { L: -1.7341, M: 16.4065, S: 0.10522 },
  120: { L: -1.7407, M: 16.4433, S: 0.10566 },
  121: { L: -1.7468, M: 16.4807, S: 0.10609 },
  122: { L: -1.7525, M: 16.5189, S: 0.10652 },
  123: { L: -1.7578, M: 16.5578, S: 0.10695 },
  124: { L: -1.7626, M: 16.5974, S: 0.10738 },
  125: { L: -1.767, M: 16.6376, S: 0.1078 },
  126: { L: -1.771, M: 16.6786, S: 0.10823 },
  127: { L: -1.7745, M: 16.7203, S: 0.10865 },
  128: { L: -1.7777, M: 16.7628, S: 0.10906 },
  129: { L: -1.7804, M: 16.8059, S: 0.10948 },
  130: { L: -1.7828, M: 16.8497, S: 0.10989 },
  131: { L: -1.7847, M: 16.8941, S: 0.1103 },
  132: { L: -1.7862, M: 16.9392, S: 0.1107 },
  133: { L: -1.7873, M: 16.985, S: 0.1111 },
  134: { L: -1.7881, M: 17.0314, S: 0.1115 },
  135: { L: -1.7884, M: 17.0784, S: 0.11189 },
  136: { L: -1.7884, M: 17.1262, S: 0.11228 },
  137: { L: -1.788, M: 17.1746, S: 0.11266 },
  138: { L: -1.7873, M: 17.2236, S: 0.11304 },
  139: { L: -1.7861, M: 17.2734, S: 0.11342 },
  140: { L: -1.7846, M: 17.324, S: 0.11379 },
  141: { L: -1.7828, M: 17.3752, S: 0.11415 },
  142: { L: -1.7806, M: 17.4272, S: 0.11451 },
  143: { L: -1.778, M: 17.4799, S: 0.11487 },
  144: { L: -1.7751, M: 17.5334, S: 0.11522 },
  145: { L: -1.7719, M: 17.5877, S: 0.11556 },
  146: { L: -1.7684, M: 17.6427, S: 0.1159 },
  147: { L: -1.7645, M: 17.6985, S: 0.11623 },
  148: { L: -1.7604, M: 17.7551, S: 0.11656 },
  149: { L: -1.7559, M: 17.8124, S: 0.11688 },
  150: { L: -1.7511, M: 17.8704, S: 0.1172 },
  151: { L: -1.7461, M: 17.9292, S: 0.11751 },
  152: { L: -1.7408, M: 17.9887, S: 0.11781 },
  153: { L: -1.7352, M: 18.0488, S: 0.11811 },
  154: { L: -1.7293, M: 18.1096, S: 0.11841 },
  155: { L: -1.7232, M: 18.171, S: 0.11869 },
  156: { L: -1.7168, M: 18.233, S: 0.11898 },
  157: { L: -1.7102, M: 18.2955, S: 0.11925 },
  158: { L: -1.7033, M: 18.3586, S: 0.11952 },
  159: { L: -1.6962, M: 18.4221, S: 0.11979 },
  160: { L: -1.6888, M: 18.486, S: 0.12005 },
  161: { L: -1.6811, M: 18.5502, S: 0.1203 },
  162: { L: -1.6732, M: 18.6148, S: 0.12055 },
  163: { L: -1.6651, M: 18.6795, S: 0.12079 },
  164: { L: -1.6568, M: 18.7445, S: 0.12102 },
  165: { L: -1.6482, M: 18.8095, S: 0.12125 },
  166: { L: -1.6394, M: 18.8746, S: 0.12148 },
  167: { L: -1.6304, M: 18.9398, S: 0.1217 },
  168: { L: -1.6211, M: 19.005, S: 0.12191 },
  169: { L: -1.6116, M: 19.0701, S: 0.12212 },
  170: { L: -1.602, M: 19.1351, S: 0.12233 },
  171: { L: -1.5921, M: 19.2, S: 0.12253 },
  172: { L: -1.5821, M: 19.2648, S: 0.12272 },
  173: { L: -1.5719, M: 19.3294, S: 0.12291 },
  174: { L: -1.5615, M: 19.3937, S: 0.1231 },
  175: { L: -1.551, M: 19.4578, S: 0.12328 },
  176: { L: -1.5403, M: 19.5217, S: 0.12346 },
  177: { L: -1.5294, M: 19.5853, S: 0.12363 },
  178: { L: -1.5185, M: 19.6486, S: 0.1238 },
  179: { L: -1.5074, M: 19.7117, S: 0.12396 },
  180: { L: -1.4961, M: 19.7744, S: 0.12412 },
  181: { L: -1.4848, M: 19.8367, S: 0.12428 },
  182: { L: -1.4733, M: 19.8987, S: 0.12443 },
  183: { L: -1.4617, M: 19.9603, S: 0.12458 },
  184: { L: -1.45, M: 20.0215, S: 0.12473 },
  185: { L: -1.4382, M: 20.0823, S: 0.12487 },
  186: { L: -1.4263, M: 20.1427, S: 0.12501 },
  187: { L: -1.4143, M: 20.2026, S: 0.12514 },
  188: { L: -1.4022, M: 20.2621, S: 0.12528 },
  189: { L: -1.39, M: 20.3211, S: 0.12541 },
  190: { L: -1.3777, M: 20.3796, S: 0.12554 },
  191: { L: -1.3653, M: 20.4376, S: 0.12567 },
  192: { L: -1.3529, M: 20.4951, S: 0.12579 },
  193: { L: -1.3403, M: 20.5521, S: 0.12591 },
  194: { L: -1.3277, M: 20.6085, S: 0.12603 },
  195: { L: -1.3149, M: 20.6644, S: 0.12615 },
  196: { L: -1.3021, M: 20.7197, S: 0.12627 },
  197: { L: -1.2892, M: 20.7745, S: 0.12638 },
  198: { L: -1.2762, M: 20.8287, S: 0.1265 },
  199: { L: -1.2631, M: 20.8824, S: 0.12661 },
  200: { L: -1.2499, M: 20.9355, S: 0.12672 },
  201: { L: -1.2366, M: 20.9881, S: 0.12683 },
  202: { L: -1.2233, M: 21.04, S: 0.12694 },
  203: { L: -1.2098, M: 21.0914, S: 0.12704 },
  204: { L: -1.1962, M: 21.1423, S: 0.12715 },
  205: { L: -1.1826, M: 21.1925, S: 0.12726 },
  206: { L: -1.1688, M: 21.2423, S: 0.12736 },
  207: { L: -1.155, M: 21.2914, S: 0.12746 },
  208: { L: -1.141, M: 21.34, S: 0.12756 },
  209: { L: -1.127, M: 21.388, S: 0.12767 },
  210: { L: -1.1129, M: 21.4354, S: 0.12777 },
  211: { L: -1.0986, M: 21.4822, S: 0.12787 },
  212: { L: -1.0843, M: 21.5285, S: 0.12797 },
  213: { L: -1.0699, M: 21.5742, S: 0.12807 },
  214: { L: -1.0553, M: 21.6193, S: 0.12816 },
  215: { L: -1.0407, M: 21.6638, S: 0.12826 },
  216: { L: -1.026, M: 21.7077, S: 0.12836 },
  217: { L: -1.0112, M: 21.751, S: 0.12845 },
  218: { L: -0.9962, M: 21.7937, S: 0.12855 },
  219: { L: -0.9812, M: 21.8358, S: 0.12864 },
  220: { L: -0.9661, M: 21.8773, S: 0.12874 },
  221: { L: -0.9509, M: 21.9182, S: 0.12883 },
  222: { L: -0.9356, M: 21.9585, S: 0.12893 },
  223: { L: -0.9202, M: 21.9982, S: 0.12902 },
  224: { L: -0.9048, M: 22.0374, S: 0.12911 },
  225: { L: -0.8892, M: 22.076, S: 0.1292 },
  226: { L: -0.8735, M: 22.114, S: 0.1293 },
  227: { L: -0.8578, M: 22.1514, S: 0.12939 },
  228: { L: -0.8419, M: 22.1883, S: 0.12948 },
};

// ============================================================
// WHO BMI-FOR-AGE: Girls (61-228 months / 5-19 years)
// Source: WHO Growth Reference Data for 5-19 years
// https://www.who.int/tools/growth-reference-data-for-5to19-years/indicators/bmi-for-age
// ============================================================
export const bmiForAgeGirls: Record<number, { L: number; M: number; S: number }> = {
  61: { L: -0.8886, M: 15.2441, S: 0.09692 },
  62: { L: -0.9068, M: 15.2434, S: 0.09738 },
  63: { L: -0.9248, M: 15.2433, S: 0.09783 },
  64: { L: -0.9427, M: 15.2438, S: 0.09829 },
  65: { L: -0.9605, M: 15.2448, S: 0.09875 },
  66: { L: -0.978, M: 15.2464, S: 0.0992 },
  67: { L: -0.9954, M: 15.2487, S: 0.09966 },
  68: { L: -1.0126, M: 15.2516, S: 0.10012 },
  69: { L: -1.0296, M: 15.2551, S: 0.10058 },
  70: { L: -1.0464, M: 15.2592, S: 0.10104 },
  71: { L: -1.063, M: 15.2641, S: 0.10149 },
  72: { L: -1.0794, M: 15.2697, S: 0.10195 },
  73: { L: -1.0956, M: 15.276, S: 0.10241 },
  74: { L: -1.1115, M: 15.2831, S: 0.10287 },
  75: { L: -1.1272, M: 15.2911, S: 0.10333 },
  76: { L: -1.1427, M: 15.2998, S: 0.10379 },
  77: { L: -1.1579, M: 15.3095, S: 0.10425 },
  78: { L: -1.1728, M: 15.32, S: 0.10471 },
  79: { L: -1.1875, M: 15.3314, S: 0.10517 },
  80: { L: -1.2019, M: 15.3439, S: 0.10562 },
  81: { L: -1.216, M: 15.3572, S: 0.10608 },
  82: { L: -1.2298, M: 15.3717, S: 0.10654 },
  83: { L: -1.2433, M: 15.3871, S: 0.107 },
  84: { L: -1.2565, M: 15.4036, S: 0.10746 },
  85: { L: -1.2693, M: 15.4211, S: 0.10792 },
  86: { L: -1.2819, M: 15.4397, S: 0.10837 },
  87: { L: -1.2941, M: 15.4593, S: 0.10883 },
  88: { L: -1.306, M: 15.4798, S: 0.10929 },
  89: { L: -1.3175, M: 15.5014, S: 0.10974 },
  90: { L: -1.3287, M: 15.524, S: 0.1102 },
  91: { L: -1.3395, M: 15.5476, S: 0.11065 },
  92: { L: -1.3499, M: 15.5723, S: 0.1111 },
  93: { L: -1.36, M: 15.5979, S: 0.11156 },
  94: { L: -1.3697, M: 15.6246, S: 0.11201 },
  95: { L: -1.379, M: 15.6523, S: 0.11246 },
  96: { L: -1.388, M: 15.681, S: 0.11291 },
  97: { L: -1.3966, M: 15.7107, S: 0.11335 },
  98: { L: -1.4047, M: 15.7415, S: 0.1138 },
  99: { L: -1.4125, M: 15.7732, S: 0.11424 },
  100: { L: -1.4199, M: 15.8058, S: 0.11469 },
  101: { L: -1.427, M: 15.8394, S: 0.11513 },
  102: { L: -1.4336, M: 15.8738, S: 0.11557 },
  103: { L: -1.4398, M: 15.909, S: 0.11601 },
  104: { L: -1.4456, M: 15.9451, S: 0.11644 },
  105: { L: -1.4511, M: 15.9818, S: 0.11688 },
  106: { L: -1.4561, M: 16.0194, S: 0.11731 },
  107: { L: -1.4607, M: 16.0575, S: 0.11774 },
  108: { L: -1.465, M: 16.0964, S: 0.11816 },
  109: { L: -1.4688, M: 16.1358, S: 0.11859 },
  110: { L: -1.4723, M: 16.1759, S: 0.11901 },
  111: { L: -1.4753, M: 16.2166, S: 0.11943 },
  112: { L: -1.478, M: 16.258, S: 0.11985 },
  113: { L: -1.4803, M: 16.2999, S: 0.12026 },
  114: { L: -1.4823, M: 16.3425, S: 0.12067 },
  115: { L: -1.4838, M: 16.3858, S: 0.12108 },
  116: { L: -1.485, M: 16.4298, S: 0.12148 },
  117: { L: -1.4859, M: 16.4746, S: 0.12188 },
  118: { L: -1.4864, M: 16.52, S: 0.12228 },
  119: { L: -1.4866, M: 16.5663, S: 0.12268 },
  120: { L: -1.4864, M: 16.6133, S: 0.12307 },
  121: { L: -1.4859, M: 16.6612, S: 0.12346 },
  122: { L: -1.4851, M: 16.71, S: 0.12384 },
  123: { L: -1.4839, M: 16.7595, S: 0.12422 },
  124: { L: -1.4825, M: 16.81, S: 0.1246 },
  125: { L: -1.4807, M: 16.8614, S: 0.12497 },
  126: { L: -1.4787, M: 16.9136, S: 0.12534 },
  127: { L: -1.4763, M: 16.9667, S: 0.12571 },
  128: { L: -1.4737, M: 17.0208, S: 0.12607 },
  129: { L: -1.4708, M: 17.0757, S: 0.12643 },
  130: { L: -1.4677, M: 17.1316, S: 0.12678 },
  131: { L: -1.4642, M: 17.1883, S: 0.12713 },
  132: { L: -1.4606, M: 17.2459, S: 0.12748 },
  133: { L: -1.4567, M: 17.3044, S: 0.12782 },
  134: { L: -1.4526, M: 17.3637, S: 0.12816 },
  135: { L: -1.4482, M: 17.4238, S: 0.12849 },
  136: { L: -1.4436, M: 17.4847, S: 0.12882 },
  137: { L: -1.4389, M: 17.5464, S: 0.12914 },
  138: { L: -1.4339, M: 17.6088, S: 0.12946 },
  139: { L: -1.4288, M: 17.6719, S: 0.12978 },
  140: { L: -1.4235, M: 17.7357, S: 0.13009 },
  141: { L: -1.418, M: 17.8001, S: 0.1304 },
  142: { L: -1.4123, M: 17.8651, S: 0.1307 },
  143: { L: -1.4065, M: 17.9306, S: 0.13099 },
  144: { L: -1.4006, M: 17.9966, S: 0.13129 },
  145: { L: -1.3945, M: 18.063, S: 0.13158 },
  146: { L: -1.3883, M: 18.1297, S: 0.13186 },
  147: { L: -1.3819, M: 18.1967, S: 0.13214 },
  148: { L: -1.3755, M: 18.2639, S: 0.13241 },
  149: { L: -1.3689, M: 18.3312, S: 0.13268 },
  150: { L: -1.3621, M: 18.3986, S: 0.13295 },
  151: { L: -1.3553, M: 18.466, S: 0.13321 },
  152: { L: -1.3483, M: 18.5333, S: 0.13347 },
  153: { L: -1.3413, M: 18.6006, S: 0.13372 },
  154: { L: -1.3341, M: 18.6677, S: 0.13397 },
  155: { L: -1.3269, M: 18.7346, S: 0.13421 },
  156: { L: -1.3195, M: 18.8012, S: 0.13445 },
  157: { L: -1.3121, M: 18.8675, S: 0.13469 },
  158: { L: -1.3046, M: 18.9335, S: 0.13492 },
  159: { L: -1.297, M: 18.9991, S: 0.13514 },
  160: { L: -1.2894, M: 19.0642, S: 0.13537 },
  161: { L: -1.2816, M: 19.1289, S: 0.13559 },
  162: { L: -1.2739, M: 19.1931, S: 0.1358 },
  163: { L: -1.2661, M: 19.2567, S: 0.13601 },
  164: { L: -1.2583, M: 19.3197, S: 0.13622 },
  165: { L: -1.2504, M: 19.382, S: 0.13642 },
  166: { L: -1.2425, M: 19.4437, S: 0.13662 },
  167: { L: -1.2345, M: 19.5045, S: 0.13681 },
  168: { L: -1.2266, M: 19.5647, S: 0.137 },
  169: { L: -1.2186, M: 19.624, S: 0.13719 },
  170: { L: -1.2107, M: 19.6824, S: 0.13738 },
  171: { L: -1.2027, M: 19.74, S: 0.13756 },
  172: { L: -1.1947, M: 19.7966, S: 0.13774 },
  173: { L: -1.1867, M: 19.8523, S: 0.13791 },
  174: { L: -1.1788, M: 19.907, S: 0.13808 },
  175: { L: -1.1708, M: 19.9607, S: 0.13825 },
  176: { L: -1.1629, M: 20.0133, S: 0.13841 },
  177: { L: -1.1549, M: 20.0648, S: 0.13858 },
  178: { L: -1.147, M: 20.1152, S: 0.13873 },
  179: { L: -1.139, M: 20.1644, S: 0.13889 },
  180: { L: -1.1311, M: 20.2125, S: 0.13904 },
  181: { L: -1.1232, M: 20.2595, S: 0.1392 },
  182: { L: -1.1153, M: 20.3053, S: 0.13934 },
  183: { L: -1.1074, M: 20.3499, S: 0.13949 },
  184: { L: -1.0996, M: 20.3934, S: 0.13963 },
  185: { L: -1.0917, M: 20.4357, S: 0.13977 },
  186: { L: -1.0838, M: 20.4769, S: 0.13991 },
  187: { L: -1.076, M: 20.517, S: 0.14005 },
  188: { L: -1.0681, M: 20.556, S: 0.14018 },
  189: { L: -1.0603, M: 20.5938, S: 0.14031 },
  190: { L: -1.0525, M: 20.6306, S: 0.14044 },
  191: { L: -1.0447, M: 20.6663, S: 0.14057 },
  192: { L: -1.0368, M: 20.7008, S: 0.1407 },
  193: { L: -1.029, M: 20.7344, S: 0.14082 },
  194: { L: -1.0212, M: 20.7668, S: 0.14094 },
  195: { L: -1.0134, M: 20.7982, S: 0.14106 },
  196: { L: -1.0055, M: 20.8286, S: 0.14118 },
  197: { L: -0.9977, M: 20.858, S: 0.1413 },
  198: { L: -0.9898, M: 20.8863, S: 0.14142 },
  199: { L: -0.9819, M: 20.9137, S: 0.14153 },
  200: { L: -0.974, M: 20.9401, S: 0.14164 },
  201: { L: -0.9661, M: 20.9656, S: 0.14176 },
  202: { L: -0.9582, M: 20.9901, S: 0.14187 },
  203: { L: -0.9503, M: 21.0138, S: 0.14198 },
  204: { L: -0.9423, M: 21.0367, S: 0.14208 },
  205: { L: -0.9344, M: 21.0587, S: 0.14219 },
  206: { L: -0.9264, M: 21.0801, S: 0.1423 },
  207: { L: -0.9184, M: 21.1007, S: 0.1424 },
  208: { L: -0.9104, M: 21.1206, S: 0.1425 },
  209: { L: -0.9024, M: 21.1399, S: 0.14261 },
  210: { L: -0.8944, M: 21.1586, S: 0.14271 },
  211: { L: -0.8863, M: 21.1768, S: 0.14281 },
  212: { L: -0.8783, M: 21.1944, S: 0.14291 },
  213: { L: -0.8703, M: 21.2116, S: 0.14301 },
  214: { L: -0.8623, M: 21.2282, S: 0.14311 },
  215: { L: -0.8542, M: 21.2444, S: 0.1432 },
  216: { L: -0.8462, M: 21.2603, S: 0.1433 },
  217: { L: -0.8382, M: 21.2757, S: 0.1434 },
  218: { L: -0.8301, M: 21.2908, S: 0.14349 },
  219: { L: -0.8221, M: 21.3055, S: 0.14359 },
  220: { L: -0.814, M: 21.32, S: 0.14368 },
  221: { L: -0.806, M: 21.3341, S: 0.14377 },
  222: { L: -0.798, M: 21.348, S: 0.14386 },
  223: { L: -0.7899, M: 21.3617, S: 0.14396 },
  224: { L: -0.7819, M: 21.3752, S: 0.14405 },
  225: { L: -0.7738, M: 21.3884, S: 0.14414 },
  226: { L: -0.7658, M: 21.4014, S: 0.14423 },
  227: { L: -0.7577, M: 21.4143, S: 0.14432 },
  228: { L: -0.7496, M: 21.4269, S: 0.14441 },
};

// ============================================================
// WEIGHT-FOR-LENGTH: Boys (45-110 cm)
// Source: WHO Child Growth Standards - Weight-for-length
// https://www.who.int/tools/child-growth-standards/standards/weight-for-length-height
// ============================================================
export const weightForLengthBoys: Record<number, { L: number; M: number; S: number }> = {
  45: { L: -0.3521, M: 2.441, S: 0.09182 },
  46: { L: -0.3521, M: 2.6077, S: 0.09124 },
  47: { L: -0.3521, M: 2.7755, S: 0.09065 },
  48: { L: -0.3521, M: 2.948, S: 0.09007 },
  49: { L: -0.3521, M: 3.1308, S: 0.08948 },
  50: { L: -0.3521, M: 3.3278, S: 0.0889 },
  51: { L: -0.3521, M: 3.5376, S: 0.08831 },
  52: { L: -0.3521, M: 3.762, S: 0.08771 },
  53: { L: -0.3521, M: 4.006, S: 0.08711 },
  54: { L: -0.3521, M: 4.2693, S: 0.08651 },
  55: { L: -0.3521, M: 4.5467, S: 0.08592 },
  56: { L: -0.3521, M: 4.8338, S: 0.08535 },
  57: { L: -0.3521, M: 5.1259, S: 0.08481 },
  58: { L: -0.3521, M: 5.418, S: 0.0843 },
  59: { L: -0.3521, M: 5.7074, S: 0.08383 },
  60: { L: -0.3521, M: 5.9907, S: 0.08342 },
  61: { L: -0.3521, M: 6.2632, S: 0.08308 },
  62: { L: -0.3521, M: 6.5251, S: 0.08279 },
  63: { L: -0.3521, M: 6.7786, S: 0.08255 },
  64: { L: -0.3521, M: 7.0255, S: 0.08236 },
  65: { L: -0.3521, M: 7.2666, S: 0.08223 },
  66: { L: -0.3521, M: 7.5034, S: 0.08215 },
  67: { L: -0.3521, M: 7.737, S: 0.08212 },
  68: { L: -0.3521, M: 7.9674, S: 0.08214 },
  69: { L: -0.3521, M: 8.1955, S: 0.08219 },
  70: { L: -0.3521, M: 8.4227, S: 0.08229 },
  71: { L: -0.3521, M: 8.648, S: 0.08241 },
  72: { L: -0.3521, M: 8.8697, S: 0.08254 },
  73: { L: -0.3521, M: 9.0865, S: 0.08269 },
  74: { L: -0.3521, M: 9.2974, S: 0.08283 },
  75: { L: -0.3521, M: 9.5032, S: 0.08295 },
  76: { L: -0.3521, M: 9.7033, S: 0.08307 },
  77: { L: -0.3521, M: 9.8963, S: 0.08314 },
  78: { L: -0.3521, M: 10.0827, S: 0.08318 },
  79: { L: -0.3521, M: 10.2649, S: 0.08316 },
  80: { L: -0.3521, M: 10.4475, S: 0.08308 },
  81: { L: -0.3521, M: 10.6352, S: 0.08293 },
  82: { L: -0.3521, M: 10.8321, S: 0.08273 },
  83: { L: -0.3521, M: 11.0415, S: 0.08246 },
  84: { L: -0.3521, M: 11.2651, S: 0.08215 },
  85: { L: -0.3521, M: 11.5007, S: 0.08181 },
  86: { L: -0.3521, M: 11.7444, S: 0.08145 },
  87: { L: -0.3521, M: 11.9916, S: 0.08111 },
  88: { L: -0.3521, M: 12.2382, S: 0.08082 },
  89: { L: -0.3521, M: 12.4815, S: 0.08058 },
  90: { L: -0.3521, M: 12.7209, S: 0.08041 },
  91: { L: -0.3521, M: 12.9569, S: 0.0803 },
  92: { L: -0.3521, M: 13.191, S: 0.08025 },
  93: { L: -0.3521, M: 13.4239, S: 0.08026 },
  94: { L: -0.3521, M: 13.6572, S: 0.08034 },
  95: { L: -0.3521, M: 13.8928, S: 0.08047 },
  96: { L: -0.3521, M: 14.1325, S: 0.08067 },
  97: { L: -0.3521, M: 14.3782, S: 0.08092 },
  98: { L: -0.3521, M: 14.6316, S: 0.08122 },
  99: { L: -0.3521, M: 14.8934, S: 0.08157 },
  100: { L: -0.3521, M: 15.1637, S: 0.08198 },
  101: { L: -0.3521, M: 15.4419, S: 0.08243 },
  102: { L: -0.3521, M: 15.7276, S: 0.08292 },
  103: { L: -0.3521, M: 16.0206, S: 0.08343 },
  104: { L: -0.3521, M: 16.3204, S: 0.08397 },
  105: { L: -0.3521, M: 16.6268, S: 0.08453 },
  106: { L: -0.3521, M: 16.9401, S: 0.0851 },
  107: { L: -0.3521, M: 17.2607, S: 0.08568 },
  108: { L: -0.3521, M: 17.5885, S: 0.08629 },
  109: { L: -0.3521, M: 17.9242, S: 0.08691 },
  110: { L: -0.3521, M: 18.2689, S: 0.08755 },
};

// ============================================================
// WEIGHT-FOR-LENGTH: Girls (45-110 cm)
// Source: WHO Child Growth Standards - Weight-for-length
// https://www.who.int/tools/child-growth-standards/standards/weight-for-length-height
// ============================================================
export const weightForLengthGirls: Record<number, { L: number; M: number; S: number }> = {
  45: { L: -0.3833, M: 2.4607, S: 0.09029 },
  46: { L: -0.3833, M: 2.6306, S: 0.09037 },
  47: { L: -0.3833, M: 2.8007, S: 0.09044 },
  48: { L: -0.3833, M: 2.9741, S: 0.09052 },
  49: { L: -0.3833, M: 3.156, S: 0.0906 },
  50: { L: -0.3833, M: 3.3518, S: 0.09068 },
  51: { L: -0.3833, M: 3.5636, S: 0.09076 },
  52: { L: -0.3833, M: 3.7911, S: 0.09085 },
  53: { L: -0.3833, M: 4.0332, S: 0.09093 },
  54: { L: -0.3833, M: 4.2875, S: 0.09102 },
  55: { L: -0.3833, M: 4.5498, S: 0.0911 },
  56: { L: -0.3833, M: 4.8162, S: 0.09118 },
  57: { L: -0.3833, M: 5.0837, S: 0.09125 },
  58: { L: -0.3833, M: 5.3507, S: 0.0913 },
  59: { L: -0.3833, M: 5.6151, S: 0.09134 },
  60: { L: -0.3833, M: 5.8742, S: 0.09136 },
  61: { L: -0.3833, M: 6.127, S: 0.09137 },
  62: { L: -0.3833, M: 6.3738, S: 0.09135 },
  63: { L: -0.3833, M: 6.6144, S: 0.09131 },
  64: { L: -0.3833, M: 6.8501, S: 0.09126 },
  65: { L: -0.3833, M: 7.0812, S: 0.09119 },
  66: { L: -0.3833, M: 7.3076, S: 0.0911 },
  67: { L: -0.3833, M: 7.5288, S: 0.09101 },
  68: { L: -0.3833, M: 7.7448, S: 0.0909 },
  69: { L: -0.3833, M: 7.9559, S: 0.09079 },
  70: { L: -0.3833, M: 8.163, S: 0.09068 },
  71: { L: -0.3833, M: 8.3666, S: 0.09056 },
  72: { L: -0.3833, M: 8.5679, S: 0.09043 },
  73: { L: -0.3833, M: 8.7661, S: 0.09031 },
  74: { L: -0.3833, M: 8.9601, S: 0.09018 },
  75: { L: -0.3833, M: 9.149, S: 0.09005 },
  76: { L: -0.3833, M: 9.3337, S: 0.08992 },
  77: { L: -0.3833, M: 9.5166, S: 0.08979 },
  78: { L: -0.3833, M: 9.7015, S: 0.08965 },
  79: { L: -0.3833, M: 9.8915, S: 0.08952 },
  80: { L: -0.3833, M: 10.0891, S: 0.0894 },
  81: { L: -0.3833, M: 10.2965, S: 0.08928 },
  82: { L: -0.3833, M: 10.514, S: 0.08918 },
  83: { L: -0.3833, M: 10.741, S: 0.0891 },
  84: { L: -0.3833, M: 10.9767, S: 0.08903 },
  85: { L: -0.3833, M: 11.2198, S: 0.08898 },
  86: { L: -0.3833, M: 11.4684, S: 0.08895 },
  87: { L: -0.3833, M: 11.7201, S: 0.08895 },
  88: { L: -0.3833, M: 11.972, S: 0.08896 },
  89: { L: -0.3833, M: 12.2229, S: 0.089 },
  90: { L: -0.3833, M: 12.4723, S: 0.08906 },
  91: { L: -0.3833, M: 12.7205, S: 0.08913 },
  92: { L: -0.3833, M: 12.9681, S: 0.08923 },
  93: { L: -0.3833, M: 13.2158, S: 0.08934 },
  94: { L: -0.3833, M: 13.4643, S: 0.08948 },
  95: { L: -0.3833, M: 13.7146, S: 0.08963 },
  96: { L: -0.3833, M: 13.9676, S: 0.08981 },
  97: { L: -0.3833, M: 14.2239, S: 0.09 },
  98: { L: -0.3833, M: 14.4848, S: 0.09021 },
  99: { L: -0.3833, M: 14.7519, S: 0.09044 },
  100: { L: -0.3833, M: 15.0267, S: 0.09069 },
  101: { L: -0.3833, M: 15.3108, S: 0.09096 },
  102: { L: -0.3833, M: 15.6046, S: 0.09125 },
  103: { L: -0.3833, M: 15.9087, S: 0.09155 },
  104: { L: -0.3833, M: 16.2229, S: 0.09186 },
  105: { L: -0.3833, M: 16.547, S: 0.09219 },
  106: { L: -0.3833, M: 16.8814, S: 0.09254 },
  107: { L: -0.3833, M: 17.2269, S: 0.09289 },
  108: { L: -0.3833, M: 17.5839, S: 0.09326 },
  109: { L: -0.3833, M: 17.9526, S: 0.09363 },
  110: { L: -0.3833, M: 18.3324, S: 0.09401 },
};

// ============================================================
// HELPER FUNCTIONS
// ============================================================

/**
 * Linear interpolation for LMS values between two data points
 */
function interpolateLMS(
  data: Record<number, { L: number; M: number; S: number }>,
  value: number
): { L: number; M: number; S: number } {
  const keys = Object.keys(data).map(Number).sort((a, b) => a - b);
  
  // Exact match
  if (data[value]) {
    return data[value];
  }
  
  // Find surrounding keys
  let lower = keys[0];
  let upper = keys[keys.length - 1];
  
  for (let i = 0; i < keys.length - 1; i++) {
    if (keys[i] <= value && keys[i + 1] >= value) {
      lower = keys[i];
      upper = keys[i + 1];
      break;
    }
  }
  
  // Clamp to range
  if (value <= lower) {
    return data[lower];
  }
  if (value >= upper) {
    return data[upper];
  }
  
  // Linear interpolation
  const ratio = (value - lower) / (upper - lower);
  const lowerLMS = data[lower];
  const upperLMS = data[upper];
  
  return {
    L: lowerLMS.L + ratio * (upperLMS.L - lowerLMS.L),
    M: lowerLMS.M + ratio * (upperLMS.M - lowerLMS.M),
    S: lowerLMS.S + ratio * (upperLMS.S - lowerLMS.S),
  };
}

/**
 * Calculate Z-score using WHO/CDC LMS method
 * Formula: Z = ((X/M)^L - 1) / (L × S), when L ≠ 0
 * Formula: Z = ln(X/M) / S, when L = 0
 */
export function calculateZScore(
  measurement: number,
  L: number,
  M: number,
  S: number
): number {
  if (measurement <= 0 || M <= 0 || S <= 0) {
    return 0;
  }
  
  if (Math.abs(L) < 0.0001) {
    // L is essentially 0, use logarithmic formula
    return Math.log(measurement / M) / S;
  }
  
  // Standard LMS formula
  return (Math.pow(measurement / M, L) - 1) / (L * S);
}

/**
 * Calculate measurement value at a given Z-score (inverse formula)
 * X = M × (1 + L × S × Z)^(1/L), when L ≠ 0
 * X = M × exp(S × Z), when L = 0
 */
export function calculateValueAtZScore(
  zscore: number,
  L: number,
  M: number,
  S: number
): number {
  if (Math.abs(L) < 0.0001) {
    return M * Math.exp(S * zscore);
  }
  return M * Math.pow(1 + L * S * zscore, 1 / L);
}

/**
 * Restrict extreme Z-scores using WHO method
 * For |z| > 3, calculate using fixed SD3 width
 */
export function restrictZScore(
  zscore: number,
  measurement: number,
  L: number,
  M: number,
  S: number
): number {
  if (zscore > 3) {
    const SD3 = calculateValueAtZScore(3, L, M, S);
    const SD2 = calculateValueAtZScore(2, L, M, S);
    const SD3width = SD3 - SD2;
    return 3 + (measurement - SD3) / SD3width;
  }
  if (zscore < -3) {
    const SD3neg = calculateValueAtZScore(-3, L, M, S);
    const SD2neg = calculateValueAtZScore(-2, L, M, S);
    const SD3width = SD2neg - SD3neg;
    return -3 + (measurement - SD3neg) / SD3width;
  }
  return zscore;
}

/**
 * Convert Z-score to percentile using standard normal CDF
 * Uses Abramowitz and Stegun approximation (formula 26.2.17)
 */
export function zScoreToPercentile(zscore: number): number {
  const a1 = 0.254829592;
  const a2 = -0.284496736;
  const a3 = 1.421413741;
  const a4 = -1.453152027;
  const a5 = 1.061405429;
  const p = 0.3275911;
  
  const sign = zscore < 0 ? -1 : 1;
  const z = Math.abs(zscore) / Math.sqrt(2);
  const t = 1 / (1 + p * z);
  const erf = 1 - ((((a5 * t + a4) * t + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);
  
  return (0.5 * (1 + sign * erf)) * 100;
}

/**
 * Calculate BMI
 */
export function calculateBMI(weightKg: number, heightCm: number): number {
  if (heightCm <= 0 || weightKg <= 0) return 0;
  const heightM = heightCm / 100;
  return weightKg / (heightM * heightM);
}

/**
 * BMI category by percentiles (WHO 5-19 years reference)
 * Category set requested by product:
 * - pronounced deficit
 * - normal weight
 * - overweight risk
 * - overweight
 */
export type BMICategory =
  | 'pronounced-deficit' // z < -3 SD (severely wasted / severe thinness)
  | 'underweight'        // -3 ≤ z < -2 SD (wasted / thinness)
  | 'underweight-risk'   // -2 ≤ z < -1 SD (possible risk of underweight)
  | 'normal-weight'      // -1 ≤ z ≤ +1 SD
  | 'overweight-risk'    // +1 < z ≤ +2 SD (0-5y: possible risk of overweight)
  | 'overweight'         // +2 < z ≤ +3 SD (0-5y) or +1 < z ≤ +2 SD (5-19y)
  | 'obese';             // z > +3 SD (0-5y) or z > +2 SD (5-19y)

export interface BMIResult {
  bmi: number;
  zScore: number;
  percentile: number;
  category: BMICategory;
  color: string;
}

/**
 * Calculate BMI-for-age z-score and percentile using WHO Child Growth Standards
 * Valid for ages 0-60 months
 */
export function calculateBMIForAge0to60(
  bmi: number,
  ageInDays: number,
  gender: 'male' | 'female'
): BMIResult | null {
  if (ageInDays < 0 || ageInDays > 1856) {
    return null;
  }

  if (bmi <= 0) {
    return null;
  }

  const bmiData = gender === 'male' ? bmiForAgeBoysDaily0to5 : bmiForAgeGirlsDaily0to5;
  const lms = interpolateLMS(bmiData, ageInDays);

  const rawZ = calculateZScore(bmi, lms.L, lms.M, lms.S);
  const zScore = restrictZScore(rawZ, bmi, lms.L, lms.M, lms.S);
  const percentile = zScoreToPercentile(zScore);
  
  // WHO Child Growth Standards 0-5 years BMI-for-age interpretation:
  // z < -3 SD:          Severely wasted
  // -3 ≤ z < -2 SD:     Wasted
  // -2 ≤ z < -1 SD:     Possible risk of underweight
  // -1 ≤ z ≤ +1 SD:     Normal
  // +1 < z ≤ +2 SD:     Possible risk of overweight
  // +2 < z ≤ +3 SD:     Overweight
  // z > +3 SD:           Obese
  let category: BMICategory;
  let color: string;

  // Round to 4 decimals to avoid floating-point boundary issues
  const zr = Math.round(zScore * 10000) / 10000;

  if (zr < -3) {
    category = 'pronounced-deficit';
    color = '#D32F2F';
  } else if (zr < -2) {
    category = 'underweight';
    color = '#F57C00';
  } else if (zr < -1) {
    category = 'underweight-risk';
    color = '#FFA726';
  } else if (zr > 3) {
    category = 'obese';
    color = '#D32F2F';
  } else if (zr > 2) {
    category = 'overweight';
    color = '#E64A19';
  } else if (zr > 1) {
    category = 'overweight-risk';
    color = '#FFA726';
  } else {
    category = 'normal-weight';
    color = '#388E3C';
  }

  return {
    bmi,
    zScore,
    percentile,
    category,
    color,
  };
}

/**
 * Calculate BMI-for-age z-score and category using LMS method
 * Only valid for ages 61-228 months (5-19 years)
 * 
 * @param bmi - Calculated BMI value
 * @param ageInMonths - Age in months (must be 61-228)
 * @param gender - 'male' or 'female'
 * @returns BMIResult or null if age is outside valid range
 */
export function calculateBMIForAge(
  bmi: number,
  ageInMonths: number,
  gender: 'male' | 'female'
): BMIResult | null {
  // WHO 2007 BMI-for-age reference is valid for ages 5-19 years (61-228 months)
  if (ageInMonths < 61 || ageInMonths > 228) {
    return null;
  }
  
  if (bmi <= 0) {
    return null;
  }
  
  // Select appropriate LMS data
  const bmiData = gender === 'male' ? bmiForAgeBoys : bmiForAgeGirls;
  
  // Interpolate LMS values
  const lms = interpolateLMS(bmiData, ageInMonths);
  
  // Calculate z-score
  const rawZ = calculateZScore(bmi, lms.L, lms.M, lms.S);
  const zScore = restrictZScore(rawZ, bmi, lms.L, lms.M, lms.S);
  
  // Calculate percentile
  const percentile = zScoreToPercentile(zScore);
  
  // WHO Reference 2007 BMI-for-age 5-19 years interpretation:
  // z < -3 SD:          Severe thinness
  // -3 ≤ z < -2 SD:     Thinness
  // -2 ≤ z < -1 SD:     Possible risk of underweight
  // -1 ≤ z ≤ +1 SD:     Normal
  // +1 < z ≤ +2 SD:     Overweight
  // z > +2 SD:           Obese
  let category: BMICategory;
  let color: string;

  // Round to 4 decimals to avoid floating-point boundary issues
  const zr = Math.round(zScore * 10000) / 10000;
  
  if (zr < -3) {
    category = 'pronounced-deficit';
    color = '#D32F2F'; // Red
  } else if (zr < -2) {
    category = 'underweight';
    color = '#F57C00'; // Orange
  } else if (zr < -1) {
    category = 'underweight-risk';
    color = '#FFA726'; // Light Orange
  } else if (zr > 2) {
    category = 'obese';
    color = '#D32F2F'; // Red
  } else if (zr > 1) {
    category = 'overweight';
    color = '#E64A19'; // Deep Orange
  } else {
    category = 'normal-weight';
    color = '#388E3C'; // Green
  }
  
  return {
    bmi,
    zScore,
    percentile,
    category,
    color,
  };
}

/**
 * Interpret Z-score results with status and color
 */
export function interpretZScore(zscore: number): {
  status: 'severely-low' | 'low' | 'normal' | 'high' | 'severely-high';
  color: string;
} {
  // Round to 4 decimals to avoid floating-point boundary issues
  const zr = Math.round(zscore * 10000) / 10000;
  if (zr < -3) {
    return { status: 'severely-low', color: '#D32F2F' }; // Red
  } else if (zr < -2) {
    return { status: 'low', color: '#F57C00' }; // Orange
  } else if (zr <= 2) {
    return { status: 'normal', color: '#388E3C' }; // Green
  } else if (zr <= 3) {
    return { status: 'high', color: '#F57C00' }; // Orange
  } else {
    return { status: 'severely-high', color: '#D32F2F' }; // Red
  }
}

/**
 * Interpret Weight-for-Length/Height Z-score per WHO cutoffs.
 * WHO uses asymmetric thresholds: -3, -2 for lower; +1, +2, +3 for upper.
 *
 * z < -3:       Severely wasted
 * -3 ≤ z < -2:  Wasted
 * -2 ≤ z ≤ +1:  Normal
 * +1 < z ≤ +2:  Possible risk of overweight
 * +2 < z ≤ +3:  Overweight
 * z > +3:       Obese
 */
export function interpretWFLZScore(zscore: number): {
  status: 'severely-low' | 'low' | 'normal' | 'high' | 'very-high' | 'severely-high';
  color: string;
} {
  // Round to 4 decimals to avoid floating-point boundary issues
  const zr = Math.round(zscore * 10000) / 10000;
  if (zr < -3) {
    return { status: 'severely-low', color: '#D32F2F' }; // Red
  } else if (zr < -2) {
    return { status: 'low', color: '#F57C00' }; // Orange
  } else if (zr <= 1) {
    return { status: 'normal', color: '#388E3C' }; // Green
  } else if (zr <= 2) {
    return { status: 'high', color: '#F57C00' }; // Orange — possible risk of overweight
  } else if (zr <= 3) {
    return { status: 'very-high', color: '#E64A19' }; // Deep Orange — overweight
  } else {
    return { status: 'severely-high', color: '#D32F2F' }; // Red — obese
  }
}

// ============================================================
// CALCULATION RESULT INTERFACE
// ============================================================
export interface CalculationResult {
  ageInDays: number;
  ageInMonths: number;
  
  // Length/Height for age
  lengthZScore?: number;
  lengthPercentile?: number;
  lengthStatus?: string;
  lengthColor?: string;
  
  // Weight for age
  weightZScore?: number;
  weightPercentile?: number;
  weightStatus?: string;
  weightColor?: string;
  
  // Weight for length
  weightForLengthZScore?: number;
  weightForLengthPercentile?: number;
  weightForLengthStatus?: string;
  weightForLengthColor?: string;
  
  // Head circumference for age
  headCircZScore?: number;
  headCircPercentile?: number;
  headCircStatus?: string;
  headCircColor?: string;
  
  // BMI (raw calculation)
  bmi?: number;
  
  // BMI-for-age (WHO reference for ages 5-19 years)
  bmiZScore?: number;
  bmiPercentile?: number;
  bmiCategory?: BMICategory;
  bmiColor?: string;
}

// ============================================================
// MAIN CALCULATION FUNCTION
// ============================================================
export function calculateChildGrowth(
  birthDate: Date,
  measurementDate: Date,
  gender: 'male' | 'female',
  lengthCm: number,
  weightKg: number,
  headCircCm: number
): CalculationResult {
  // Calculate age in days
  const birth = new Date(Date.UTC(birthDate.getFullYear(), birthDate.getMonth(), birthDate.getDate()));
  const measurement = new Date(Date.UTC(measurementDate.getFullYear(), measurementDate.getMonth(), measurementDate.getDate()));
  const ageInDays = Math.round((measurement.getTime() - birth.getTime()) / (1000 * 60 * 60 * 24));
  
  // Calculate age in months (for LMS lookup)
  // WHO uses age at half month point, e.g., 1.5 months = 1.0-1.99 months
  const ageInMonths = ageInDays / 30.4375;
  
  const result: CalculationResult = {
    ageInDays,
    ageInMonths,
  };
  
  // WHO Child Growth Standards data used in app covers 0-60 months
  const maxMonths = 60;
  
  // Length-for-age (0-24 months)
  if (lengthCm > 0 && ageInMonths >= 0 && ageInMonths <= maxMonths) {
    const lengthData = gender === 'male' ? lengthForAgeBoysNew : lengthForAgeGirlsNew;
    const lms = interpolateLMS(lengthData, ageInMonths);
    const rawZ = calculateZScore(lengthCm, lms.L, lms.M, lms.S);
    result.lengthZScore = restrictZScore(rawZ, lengthCm, lms.L, lms.M, lms.S);
    result.lengthPercentile = zScoreToPercentile(result.lengthZScore);
    const interpretation = interpretZScore(result.lengthZScore);
    result.lengthStatus = interpretation.status;
    result.lengthColor = interpretation.color;
  }
  
  // Weight-for-age (0-24 months)
  if (weightKg > 0 && ageInMonths >= 0 && ageInMonths <= maxMonths) {
    const weightData = gender === 'male' ? weightForAgeBoysNew : weightForAgeGirlsNew;
    const lms = interpolateLMS(weightData, ageInMonths);
    const rawZ = calculateZScore(weightKg, lms.L, lms.M, lms.S);
    result.weightZScore = restrictZScore(rawZ, weightKg, lms.L, lms.M, lms.S);
    result.weightPercentile = zScoreToPercentile(result.weightZScore);
    const interpretation = interpretZScore(result.weightZScore);
    result.weightStatus = interpretation.status;
    result.weightColor = interpretation.color;
  }
  
  // Weight-for-length/height (WHO 0-5 years)
  if (weightKg > 0 && lengthCm >= 45 && lengthCm <= 110 && ageInMonths >= 0 && ageInMonths <= maxMonths) {
    const wflData = gender === 'male' ? weightForLengthBoys : weightForLengthGirls;
    const lms = interpolateLMS(wflData, lengthCm);
    const rawZ = calculateZScore(weightKg, lms.L, lms.M, lms.S);
    result.weightForLengthZScore = restrictZScore(rawZ, weightKg, lms.L, lms.M, lms.S);
    result.weightForLengthPercentile = zScoreToPercentile(result.weightForLengthZScore);
    const interpretation = interpretWFLZScore(result.weightForLengthZScore);
    result.weightForLengthStatus = interpretation.status;
    result.weightForLengthColor = interpretation.color;
  }
  
  // Head circumference-for-age (0-24 months)
  if (headCircCm > 0 && ageInMonths >= 0 && ageInMonths <= maxMonths) {
    const headCircData = gender === 'male' ? headCircForAgeBoysNew : headCircForAgeGirlsNew;
    const lms = interpolateLMS(headCircData, ageInMonths);
    const rawZ = calculateZScore(headCircCm, lms.L, lms.M, lms.S);
    result.headCircZScore = restrictZScore(rawZ, headCircCm, lms.L, lms.M, lms.S);
    result.headCircPercentile = zScoreToPercentile(result.headCircZScore);
    const interpretation = interpretZScore(result.headCircZScore);
    result.headCircStatus = interpretation.status;
    result.headCircColor = interpretation.color;
  }
  
  // Calculate BMI for ages 0-20 years (0-240 months)
  if (weightKg > 0 && lengthCm > 0 && ageInMonths >= 0 && ageInMonths <= 240) {
    result.bmi = calculateBMI(weightKg, lengthCm);

    // BMI-for-age: WHO 0-5 years (0-60 months), WHO reference 5-19 years (61-228 months)
    if (ageInMonths <= 60) {
      const bmiResult0to60 = calculateBMIForAge0to60(result.bmi, ageInDays, gender);
      if (bmiResult0to60) {
        result.bmiZScore = bmiResult0to60.zScore;
        result.bmiPercentile = bmiResult0to60.percentile;
        result.bmiCategory = bmiResult0to60.category;
        result.bmiColor = bmiResult0to60.color;
      }
    } else {
      const bmiResult = calculateBMIForAge(result.bmi, ageInMonths, gender);
      if (bmiResult) {
        result.bmiZScore = bmiResult.zScore;
        result.bmiPercentile = bmiResult.percentile;
        result.bmiCategory = bmiResult.category;
        result.bmiColor = bmiResult.color;
      }
    }
  }
  
  return result;
}

// ============================================================
// CHART DATA GENERATION
// ============================================================
export function generateGrowthCurveData(
  gender: 'male' | 'female',
  chartType: 'length' | 'weight' | 'headCirc'
): { age: number; median: number; sd1: number; sd2: number; sd3: number; sd1neg: number; sd2neg: number; sd3neg: number }[] {
  let data: Record<number, { L: number; M: number; S: number }>;
  
  switch (chartType) {
    case 'length':
      data = gender === 'male' ? lengthForAgeBoysNew : lengthForAgeGirlsNew;
      break;
    case 'weight':
      data = gender === 'male' ? weightForAgeBoysNew : weightForAgeGirlsNew;
      break;
    case 'headCirc':
      data = gender === 'male' ? headCircForAgeBoysNew : headCircForAgeGirlsNew;
      break;
  }
  
  return Object.entries(data).map(([age, lms]) => {
    const ageNum = parseInt(age);
    const { L, M, S } = lms;
    
    return {
      age: ageNum,
      median: M,
      sd1: calculateValueAtZScore(1, L, M, S),
      sd2: calculateValueAtZScore(2, L, M, S),
      sd3: calculateValueAtZScore(3, L, M, S),
      sd1neg: calculateValueAtZScore(-1, L, M, S),
      sd2neg: calculateValueAtZScore(-2, L, M, S),
      sd3neg: calculateValueAtZScore(-3, L, M, S),
    };
  }).sort((a, b) => a.age - b.age);
}

// Export old names for backward compatibility
export const heightForAgeBoys = lengthForAgeBoysNew;
export const heightForAgeGirls = lengthForAgeGirlsNew;
